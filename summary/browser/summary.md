# 브라우저 구성요소

- 사용자 인터페이스 : 주소 표시줄, 이전/다음 버튼, 북마크 메뉴 등..
- 브라우저 엔진 : 사용자 인터페이스와 렌더링 엔진 사이의 동작을 제어
- 렌더링 엔진
- 통신 : HTTP 요청과 같은 네트워크 호출
- UI 백엔드 : 콤보박스와 창 같은 기본적인 UI. OS사용자 인터페이스 사용
- 자바스크립트 해석기 : 자바스크립트 코드 실행
- 자료 저장소

## 렌더링 엔진

요청받은 내용을 브라우저 화면에 표시하는 일.

### 렌더링 주요 엔진들

모질라 게코, 사파리 크롬은 웹킷, 현재는 웹킷으로 통일.

### 렌더링 동작과정

- 돔 트리 구축을 위한 HTML, CSS파싱
- 렌더 트리 구축( 색상 또는 면적과 같은 시각적 속성이 있는 사각형을 포함하고 있으며 정해진 순서대로 화면에 표시 )
- 렌더 트리 배치 ( 노드가 화면에 표시되는 것을 의미 )
- 렌더 트리 그리기 ( UI 백엔드에서 렌더 트리의 각 노드를 가로지르며 형상을 만들어 내는 그리기 과정 )

렌더링 엔진은 더 나은 사용자 경험을 위해 모든 HTML파싱을 기다리지 않고 배치와 그리기 과정을 시작한다.
네트웍크를 통해 전성되는 내용을 기다리며 내용의 일부를 먼저 화면에 표시.

### 파싱과 돔 트리구축

문서 파싱은 브라우저가 코드를 이해하고 사용할 수 있는 구조로 변환하는 것을 의미.
결과는 파싱 트리 혹은 문법 트리라고 부른다.

### 파서-어휘 분석기 조합

파싱은 어휘 분석과 구문 분석이라는 두 가지로 구분할 수 있다.
어휘 분석은 자료를 토큰으로 분해하는 과정.
유용하게 구성된 단위의 집합체로 용어집이라 할 수 있음. 인간의 언어로 말하면 사전에 등장하는 모든 단어에 해당한다.

파싱은 반복적으로 수행하며 규칙에 맞지 않으면 파서는 토큰을 내부적으로 저장하고 토큰과 일치하는 규칙이 발견될 때까지 요청한다.
맞는 규칙이 없는 경우 예외로 처리하며 이것은 문서가 유효하지 않고 오류를 포함한다는 의미.

### 파서가 하는 일

- 자료를 유효한 토큰으로 분해 -> 어휘 분석기( 토큰 변환기 )
- 언어 구문 규칙에 따라 문서 구조를 분석하고 파싱 트리를 생성.

### 변환

파서 트리가 끝나면 컴파일을 통해 소스 코드를 기계 코드 문서로 만든다.

### 파서의 종류

하향식과 상향식 파서가 있다.

### 파서 자동 생성

수동으로 파서를 최적화하여 생성하는 것은 쉬운 일이 아니기 때문에 파서 생성기는 매우 유용.  
웹킷은 잘 알려진 두 개의 파서 생성기를 사용.

- 어휘 생성을 위한 <mark>플렉스(Flex)</mark>
- 파서 생성을 위한 <mark>바이슨(Bison)</mark>

### DOM파싱 알고리즘

토큰화와 트리 구축 두 단계로 구성.
일반적인 상향식, 하향식 파서로는 파상이 안되는데 이유는 다음과 같다.

- 언어의 너그러운 속성
- 잘 알려져 있는 HTML오류에 대한 브라우저의 관용
- 변경에 의한 재파싱. 일반적인 소스는 파싱하는 동안 변화가 없지만 document.wirte를 이용하면 입력과정에서 파싱이 수정됨.

#### 토큰화 알고리즘

알고리즘의 결과물은 HTML토큰이다. 알고리즘은 상태 기계(State Machine)라고 볼 수 있다.
각 상태는 하나 이상의 문자를 입력받아 이 문자에 따라 다음 상태를 갱신한다.

주요 상태 정리

- 자료 상태 : 초기 시작 상태값.
- 태그열림 상태 : <mark>></mark>문자를 만나면 시작.
- 태그이름 상태 : a~z까지의 문자를 만나며 이 상태는 <mark>></mark>를 만날 때까지 유지한다.
- 각 문자에는 새로운 HTML토큰이 생성되어 붙는다.
- 태그이름 상태에서 <mark>></mark>를 만나면 다시 자료상태로 돌아가며 반복됨.

### 트리 구축 알고리즘

토큰화에 의해 발행된 각 노드는 트리 생성자에 의해 처리된다. 각 토큰을 위한 DOM요소의 명세는 정의되어 있다.
알고리즘은 상태 기계라 할 수 있고 삽입 모드 라고 부른다.

### 파싱 이후 동작

브라우저는 문서와 상호작용할 수 있게 되고 스크립트를 파싱하기 시작한다.  
문서 상태는 완료가 되고 로드 이벤트가 발생.

- 파서가 처리하는 브라우저 오류 처리
  - 어떤 태그의 안쪽에 추가하려는 태그가 금지된 것이 ㄹ때 일단 허용된 태그를 먼저 닫고 금지된 태그는 외부에 추가한다.
  - 파서가 직접 요소를 추가해서는 안된다.
  - 인라인 요소 안쪽에 블록 요소가 있을 경우 부모 블록 요소를 만날 때까지 모든 인라인 태그를 닫는다.

### 스크립트와 스타일 시트의 진행 순서

- script가 실행되는 동안 문서의 파싱은 중단된다.
- 외부 네트웍크를 통해 가져온다면 자원을 받을 때 까지 파싱은 중단된다.
- HTML5명세에 deffer가 추가되며 문서 파싱 중단없이 적용이 가능
